<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏±‡∏°‡∏°‡∏ô‡∏≤ - ‡∏ß‡∏£‡∏≤‡∏£‡∏¥‡∏ô ‡∏û‡∏£‡πá‡∏≠‡∏û‡πÄ‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏µ‡πâ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Sarabun -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #10b981;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Navbar -->
    <nav class="bg-emerald-700 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2 cursor-pointer hover:opacity-80 transition" onclick="openLoginModal()" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin">
                <i class="fa-solid fa-house-chimney text-xl"></i>
                <span class="font-bold text-lg md:text-xl">Wararin Property</span>
                <i class="fa-solid fa-lock text-xs opacity-70" id="lockIcon"></i>
            </div>
            <div class="flex space-x-4">
                <button onclick="switchTab('register')" id="btn-register" class="px-3 py-1 rounded bg-white text-emerald-700 font-bold transition">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                <!-- ‡∏õ‡∏∏‡πà‡∏° Dashboard ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞ login -->
                <button onclick="switchTab('dashboard')" id="btn-dashboard" class="hidden px-3 py-1 rounded hover:bg-emerald-600 transition">Dashboard</button>
                <!-- ‡∏õ‡∏∏‡πà‡∏° Logout ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô -->
                <button onclick="logout()" id="btn-logout" class="hidden px-3 py-1 rounded hover:bg-red-500 transition" title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-6">

        <!-- ======================= -->
        <!-- SECTION: Registration Form -->
        <!-- ======================= -->
        <div id="register-section" class="max-w-2xl mx-auto animate-fade-in">
            <!-- Header Banner -->
            <div class="bg-gradient-to-r from-emerald-600 to-teal-500 rounded-t-xl p-6 text-white text-center shadow-lg">
                <h1 class="text-2xl font-bold mb-2">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏±‡∏°‡∏°‡∏ô‡∏≤ "999 ‡∏ö‡∏≤‡∏ó ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï"</h1>
                <p class="opacity-90">‡πÅ‡∏Å‡πâ‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏°‡∏µ‡∏ö‡πâ‡∏≤‡∏ô ‡∏°‡∏µ‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï</p>
            </div>

            <div class="glass-card p-6 rounded-b-xl shadow-xl">
                <!-- Payment Info -->
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded-r">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <i class="fa-solid fa-circle-info text-blue-500 mt-1"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-bold text-blue-800">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô 999 ‡∏ö‡∏≤‡∏ó)</h3>
                            <div class="mt-2 text-sm text-blue-700">
                                <p>üè¶ ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£: <span class="font-bold">‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ (K-Bank)</span></p>
                                <p>üî¢ ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: <span class="font-bold text-lg select-all bg-white px-1 rounded">162-3-41428-7</span></p>
                                <p>üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: <span class="font-bold">‡∏ö‡∏à‡∏Å.‡∏ß‡∏£‡∏≤‡∏£‡∏¥‡∏ô ‡∏û‡∏£‡πá‡∏≠‡∏û‡πÄ‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏µ‡πâ</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form -->
                <form id="regisForm" onsubmit="handleRegister(event)">
                    <input type="hidden" id="editIndex" value="-1">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="text-red-500">*</span></label>
                            <input type="text" id="fullname" required class="w-full p-2 border rounded focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô <span class="text-red-500">*</span></label>
                            <input type="text" id="nickname" required class="w-full p-2 border rounded focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="‡∏ä‡∏≤‡∏¢">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå <span class="text-red-500">*</span></label>
                            <input type="tel" id="phone" required pattern="[0-9]{9,10}" class="w-full p-2 border rounded focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="0812345678">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Line ID <span class="text-red-500">*</span></label>
                            <input type="text" id="lineId" required class="w-full p-2 border rounded focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="@lineid">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô Level)</label>
                        <select id="debtStatus" class="w-full p-2 border rounded focus:ring-2 focus:ring-emerald-500 outline-none">
                            <option value="normal">üü¢ ‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏à‡πà‡∏≤‡∏¢‡∏ï‡∏£‡∏á‡∏ï‡∏•‡∏≠‡∏î)</option>
                            <option value="warning">üü° ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏∂‡∏á (‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥/‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏á‡∏¥‡∏ô)</option>
                            <option value="heavy">üü† ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏Å (‡∏Ñ‡πâ‡∏≤‡∏á 1-3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡πÇ‡∏î‡∏ô‡∏ó‡∏ß‡∏á)</option>
                            <option value="critical">üî¥ ‡∏ß‡∏¥‡∏Å‡∏§‡∏ï (‡∏ü‡πâ‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏á/‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏î‡∏µ)</option>
                        </select>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium mb-1">‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô <span class="text-red-500">*</span></label>
                        <input type="file" id="slipFile" accept="image/*" class="hidden" onchange="handleFileSelect(this)" required>
                        
                        <!-- Upload Area -->
                        <div id="uploadArea" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 hover:border-emerald-400 cursor-pointer transition-all" onclick="document.getElementById('slipFile').click()">
                            <i class="fa-solid fa-cloud-arrow-up text-gray-400 text-4xl mb-3"></i>
                            <p class="text-sm text-gray-600 font-medium">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ</p>
                            <p class="text-xs text-gray-400 mt-1">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö JPG, PNG, GIF (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB)</p>
                        </div>
                        
                        <!-- Image Preview -->
                        <div id="imagePreview" class="hidden mt-4">
                            <div class="relative inline-block w-full">
                                <div class="bg-gray-100 rounded-lg p-3 border">
                                    <p class="text-xs text-gray-500 mb-2 flex items-center">
                                        <i class="fa-solid fa-image mr-2 text-emerald-500"></i>
                                        <span id="fileName">‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
                                    </p>
                                    <img id="previewImg" class="max-h-64 mx-auto rounded-lg shadow-md border">
                                </div>
                                <button type="button" onclick="removeImage()" class="absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 text-white rounded-full w-8 h-8 flex items-center justify-center shadow-lg transition">
                                    <i class="fa-solid fa-times"></i>
                                </button>
                            </div>
                            <button type="button" onclick="document.getElementById('slipFile').click()" class="mt-2 text-sm text-emerald-600 hover:text-emerald-800 underline">
                                <i class="fa-solid fa-arrows-rotate mr-1"></i> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ
                            </button>
                        </div>
                    </div>

                    <button type="submit" id="submitBtn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg shadow transition transform active:scale-95">
                        <i class="fa-solid fa-paper-plane mr-2"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
                    </button>
                    <button type="button" id="cancelEditBtn" onclick="resetForm()" class="hidden w-full mt-2 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 rounded-lg">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    </button>
                </form>

                <!-- Alert Messages -->
                <div id="alertBox" class="hidden mt-4 p-4 rounded-lg"></div>
            </div>
        </div>

        <!-- ======================= -->
        <!-- SECTION: Admin Dashboard -->
        <!-- ======================= -->
        <div id="dashboard-section" class="hidden animate-fade-in">
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-4 rounded-xl shadow border-l-4 border-emerald-500 flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500 font-bold uppercase">‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                        <p class="text-2xl font-bold text-gray-800" id="total-registrants">0</p>
                    </div>
                    <i class="fa-solid fa-users text-emerald-200 text-3xl"></i>
                </div>
                <div class="bg-white p-4 rounded-xl shadow border-l-4 border-blue-500 flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500 font-bold uppercase">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</p>
                        <p class="text-2xl font-bold text-blue-600" id="total-income">0</p>
                    </div>
                    <i class="fa-solid fa-sack-dollar text-blue-200 text-3xl"></i>
                </div>
                <div class="bg-white p-4 rounded-xl shadow border-l-4 border-red-500 flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500 font-bold uppercase">‡πÄ‡∏Ñ‡∏™‡∏ß‡∏¥‡∏Å‡∏§‡∏ï (‡∏™‡∏µ‡πÅ‡∏î‡∏á)</p>
                        <p class="text-2xl font-bold text-red-600" id="critical-cases">0</p>
                    </div>
                    <i class="fa-solid fa-triangle-exclamation text-red-200 text-3xl"></i>
                </div>
                <div class="bg-white p-4 rounded-xl shadow border-l-4 border-yellow-500 flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500 font-bold uppercase">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ</p>
                        <p class="text-2xl font-bold text-yellow-600" id="pending-check">0</p>
                    </div>
                    <i class="fa-solid fa-file-invoice-dollar text-yellow-200 text-3xl"></i>
                </div>
            </div>

            <!-- Refresh Button & Filter -->
            <div class="flex flex-wrap gap-4 mb-4 items-center justify-between">
                <div class="flex gap-2">
                    <button onclick="loadDataFromSheets()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg shadow">
                        <i class="fa-solid fa-rotate mr-2"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                    <select id="filterStatus" onchange="filterTable()" class="p-2 border rounded-lg">
                        <option value="all">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="normal">üü¢ ‡∏õ‡∏Å‡∏ï‡∏¥</option>
                        <option value="warning">üü° ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏∂‡∏á</option>
                        <option value="heavy">üü† ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏Å</option>
                        <option value="critical">üî¥ ‡∏ß‡∏¥‡∏Å‡∏§‡∏ï</option>
                    </select>
                </div>
                <button onclick="exportToCSV()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg shadow">
                    <i class="fa-solid fa-file-csv mr-2"></i> Export CSV
                </button>
            </div>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="hidden text-center py-8">
                <div class="loading-spinner mx-auto mb-2"></div>
                <p class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>

            <!-- Table -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                    <h2 class="font-bold text-lg text-gray-700"><i class="fa-solid fa-table-list mr-2"></i>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h2>
                    <span id="lastUpdate" class="text-xs text-gray-400"></span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600 text-sm uppercase tracking-wider">
                                <th class="p-4">#</th>
                                <th class="p-4">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                <th class="p-4">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</th>
                                <th class="p-4">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                                <th class="p-4">Line ID</th>
                                <th class="p-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏ô‡∏µ‡πâ</th>
                                <th class="p-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
                                <th class="p-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th class="p-4 text-center">‡∏™‡∏•‡∏¥‡∏õ</th>
                                <th class="p-4 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="registrantsTable">
                            <tr>
                                <td colspan="10" class="p-8 text-center text-gray-400">
                                    <i class="fa-solid fa-database text-4xl mb-2"></i>
                                    <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î "‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <span id="toastMessage"></span>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform transition-all animate-fade-in">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-emerald-600 to-teal-500 rounded-t-2xl p-6 text-white text-center">
                <i class="fa-solid fa-user-shield text-4xl mb-3"></i>
                <h2 class="text-xl font-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin</h2>
                <p class="text-sm opacity-80">Wararin Property</p>
            </div>
            
            <!-- Modal Body -->
            <div class="p-6">
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fa-solid fa-user mr-2 text-emerald-600"></i>Username
                        </label>
                        <input type="text" id="loginUsername" required 
                               class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 outline-none transition"
                               placeholder="‡∏Å‡∏£‡∏≠‡∏Å Username">
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fa-solid fa-lock mr-2 text-emerald-600"></i>Password
                        </label>
                        <div class="relative">
                            <input type="password" id="loginPassword" required 
                                   class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 outline-none transition pr-12"
                                   placeholder="‡∏Å‡∏£‡∏≠‡∏Å Password">
                            <button type="button" onclick="togglePassword()" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                <i class="fa-solid fa-eye" id="togglePasswordIcon"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Error Message -->
                    <div id="loginError" class="hidden mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm">
                        <i class="fa-solid fa-circle-exclamation mr-2"></i>
                        <span id="loginErrorText">Username ‡∏´‡∏£‡∏∑‡∏≠ Password ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>
                    </div>
                    
                    <button type="submit" id="loginBtn" 
                            class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg shadow transition transform active:scale-95">
                        <i class="fa-solid fa-right-to-bracket mr-2"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                    </button>
                </form>
            </div>
            
            <!-- Modal Footer -->
            <div class="px-6 pb-6">
                <button onclick="closeLoginModal()" class="w-full py-2 text-gray-500 hover:text-gray-700 transition text-sm">
                    <i class="fa-solid fa-xmark mr-1"></i> ‡∏õ‡∏¥‡∏î
                </button>
            </div>
        </div>
    </div>

    <!-- ======================= -->
    <!-- JavaScript -->
    <!-- ======================= -->
    <script>
        // ==================================================
        // ‚öôÔ∏è CONFIG: ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Google Apps Script Web App
        // ==================================================
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbznO5SsF75Vo83D-OSlCd4QLCevyCCJO97Aw0WzcqDsnnmmhILXXf2jSAvrjwpkra3GHw/exec';
        
        // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
        const REGISTRATION_FEE = 999;
        
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å Sheets
        let allRegistrants = [];
        
        // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Login
        let isLoggedIn = false;

        // ==================================================
        // üîê Login Functions
        // ==================================================
        function openLoginModal() {
            if (isLoggedIn) return; // ‡∏ñ‡πâ‡∏≤ login ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î modal
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('loginUsername').focus();
        }

        function closeLoginModal() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').classList.add('hidden');
        }

        function togglePassword() {
            const passwordInput = document.getElementById('loginPassword');
            const icon = document.getElementById('togglePasswordIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const loginBtn = document.getElementById('loginBtn');
            const originalText = loginBtn.innerHTML;
            
            // ‡πÅ‡∏™‡∏î‡∏á loading
            loginBtn.innerHTML = '<span class="loading-spinner mr-2"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';
            loginBtn.disabled = true;
            document.getElementById('loginError').classList.add('hidden');
            
            try {
                // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà Google Sheets
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=checkLogin&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`);
                const result = await response.json();
                
                if (result.status === 'success' && result.valid === true) {
                    // Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                    isLoggedIn = true;
                    closeLoginModal();
                    showAdminUI();
                    showToast(`‚úÖ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${username}!`);
                    
                    // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ login ‡πÉ‡∏ô sessionStorage
                    sessionStorage.setItem('isLoggedIn', 'true');
                    sessionStorage.setItem('username', username);
                } else {
                    // Login ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                    document.getElementById('loginErrorText').textContent = result.message || 'Username ‡∏´‡∏£‡∏∑‡∏≠ Password ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                    document.getElementById('loginError').classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                document.getElementById('loginErrorText').textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
                document.getElementById('loginError').classList.remove('hidden');
            } finally {
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
            }
        }

        function showAdminUI() {
            // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° Dashboard ‡πÅ‡∏•‡∏∞ Logout
            document.getElementById('btn-dashboard').classList.remove('hidden');
            document.getElementById('btn-logout').classList.remove('hidden');
            // ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏∏‡∏ç‡πÅ‡∏à
            document.getElementById('lockIcon').classList.add('hidden');
            // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà logo
            const logo = document.querySelector('nav .cursor-pointer');
            if (logo) {
                logo.classList.remove('cursor-pointer', 'hover:opacity-80');
                logo.onclick = null;
                logo.title = '';
            }
        }

        function hideAdminUI() {
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° Dashboard ‡πÅ‡∏•‡∏∞ Logout
            document.getElementById('btn-dashboard').classList.add('hidden');
            document.getElementById('btn-logout').classList.add('hidden');
            // ‡∏ã‡πà‡∏≠‡∏ô Dashboard section
            document.getElementById('dashboard-section').classList.add('hidden');
            // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
            document.getElementById('register-section').classList.remove('hidden');
            // Reset ‡∏õ‡∏∏‡πà‡∏°
            document.getElementById('btn-register').classList.add('bg-white', 'text-emerald-700', 'font-bold');
        }

        function logout() {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                isLoggedIn = false;
                sessionStorage.removeItem('isLoggedIn');
                sessionStorage.removeItem('username');
                hideAdminUI();
                showToast('üëã ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
                
                // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤
                setTimeout(() => location.reload(), 1000);
            }
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö session ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
        function checkSession() {
            const savedLogin = sessionStorage.getItem('isLoggedIn');
            if (savedLogin === 'true') {
                isLoggedIn = true;
                showAdminUI();
                // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å switchTab ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ showAdminUI ‡πÅ‡∏™‡∏î‡∏á register section ‡πÅ‡∏•‡πâ‡∏ß
            }
        }

        // ==================================================
        // üîÑ Switch Tabs
        // ==================================================
        function switchTab(tab) {
            const registerSection = document.getElementById('register-section');
            const dashboardSection = document.getElementById('dashboard-section');
            const btnRegister = document.getElementById('btn-register');
            const btnDashboard = document.getElementById('btn-dashboard');

            if (tab === 'register') {
                registerSection.classList.remove('hidden');
                dashboardSection.classList.add('hidden');
                btnRegister.classList.add('bg-white', 'text-emerald-700', 'font-bold');
                btnRegister.classList.remove('hover:bg-emerald-600');
                btnDashboard.classList.remove('bg-white', 'text-emerald-700', 'font-bold');
                btnDashboard.classList.add('hover:bg-emerald-600');
            } else if (tab === 'dashboard') {
                registerSection.classList.add('hidden');
                dashboardSection.classList.remove('hidden');
                btnDashboard.classList.add('bg-white', 'text-emerald-700', 'font-bold');
                btnDashboard.classList.remove('hover:bg-emerald-600');
                btnRegister.classList.remove('bg-white', 'text-emerald-700', 'font-bold');
                btnRegister.classList.add('hover:bg-emerald-600');
                
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤ Dashboard
                loadDataFromSheets();
            }
        }

        // ==================================================
        // üì§ Handle Registration Form Submit
        // ==================================================
        async function handleRegister(event) {
            event.preventDefault();
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
            if (!slipImageBase64) {
                showAlert('error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô');
                showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            
            // ‡πÅ‡∏™‡∏î‡∏á loading
            submitBtn.innerHTML = '<span class="loading-spinner mr-2"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            submitBtn.disabled = true;

            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
            const formData = {
                fullname: document.getElementById('fullname').value.trim(),
                nickname: document.getElementById('nickname').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                lineId: document.getElementById('lineId').value.trim(),
                debtStatus: document.getElementById('debtStatus').value,
                timestamp: new Date().toLocaleString('th-TH'),
                paymentStatus: 'pending', // ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                slipImage: slipImageBase64, // ‡∏£‡∏π‡∏õ base64
                slipFileName: slipFileName || 'slip.jpg'
            };

            try {
                // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheets
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain', // ‡πÉ‡∏ä‡πâ text/plain ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á CORS preflight
                    },
                    body: JSON.stringify({
                        action: 'addRegistration',
                        data: formData
                    })
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    showAlert('success', '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ');
                    showToast('‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    resetForm();
                } else {
                    throw new Error(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                }

            } catch (error) {
                console.error('Error:', error);
                // ‡πÅ‡∏°‡πâ‡∏à‡∏∞ error ‡∏à‡∏≤‡∏Å CORS ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏à‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
                showAlert('success', '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ');
                showToast('‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                resetForm();
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // ==================================================
        // üì• Load Data from Google Sheets
        // ==================================================
        async function loadDataFromSheets() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const tableBody = document.getElementById('registrantsTable');
            
            loadingIndicator.classList.remove('hidden');
            
            try {
                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getRegistrations`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    allRegistrants = result.data;
                    renderTable(allRegistrants);
                    updateStats(allRegistrants);
                    document.getElementById('lastUpdate').textContent = 
                        `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date().toLocaleString('th-TH')}`;
                } else {
                    throw new Error(result.message);
                }
                
            } catch (error) {
                console.error('Error loading data:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="p-8 text-center text-red-400">
                            <i class="fa-solid fa-exclamation-circle text-4xl mb-2"></i>
                            <p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>
                            <p class="text-xs">${error.message}</p>
                        </td>
                    </tr>
                `;
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        // ==================================================
        // üìä Render Table
        // ==================================================
        function renderTable(data) {
            const tableBody = document.getElementById('registrantsTable');
            
            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="p-8 text-center text-gray-400">
                            <i class="fa-solid fa-inbox text-4xl mb-2"></i>
                            <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = data.map((item, index) => `
                <tr class="border-b hover:bg-gray-50 transition" data-status="${item.debtStatus}">
                    <td class="p-4 font-medium">${index + 1}</td>
                    <td class="p-4 font-medium">${escapeHtml(item.fullname)}</td>
                    <td class="p-4">${escapeHtml(item.nickname)}</td>
                    <td class="p-4">
                        <a href="tel:${item.phone}" class="text-blue-600 hover:underline">${item.phone}</a>
                    </td>
                    <td class="p-4">${escapeHtml(item.lineId)}</td>
                    <td class="p-4">${getDebtStatusBadge(item.debtStatus)}</td>
                    <td class="p-4 text-sm text-gray-500">${item.timestamp}</td>
                    <td class="p-4">${getPaymentStatusBadge(item.paymentStatus)}</td>
                    <td class="p-4 text-center">
                        ${item.slipUrl ? `<a href="${item.slipUrl}" target="_blank" class="text-blue-600 hover:text-blue-800" title="‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ"><i class="fa-solid fa-image"></i></a>` : '<span class="text-gray-300"><i class="fa-solid fa-image-slash"></i></span>'}
                    </td>
                    <td class="p-4 text-center">
                        <button onclick="updatePaymentStatus(${item.rowIndex}, 'confirmed')" 
                                class="text-green-600 hover:text-green-800 mx-1" title="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞">
                            <i class="fa-solid fa-circle-check"></i>
                        </button>
                        <button onclick="updatePaymentStatus(${item.rowIndex}, 'pending')" 
                                class="text-yellow-600 hover:text-yellow-800 mx-1" title="‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö">
                            <i class="fa-solid fa-clock"></i>
                        </button>
                        <button onclick="deleteRegistrant(${item.rowIndex})" 
                                class="text-red-600 hover:text-red-800 mx-1" title="‡∏•‡∏ö">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // ==================================================
        // üìà Update Statistics
        // ==================================================
        function updateStats(data) {
            const total = data.length;
            const confirmed = data.filter(d => d.paymentStatus === 'confirmed').length;
            const critical = data.filter(d => d.debtStatus === 'critical').length;
            const pending = data.filter(d => d.paymentStatus === 'pending').length;

            document.getElementById('total-registrants').textContent = total;
            document.getElementById('total-income').textContent = (confirmed * REGISTRATION_FEE).toLocaleString();
            document.getElementById('critical-cases').textContent = critical;
            document.getElementById('pending-check').textContent = pending;
        }

        // ==================================================
        // üîç Filter Table
        // ==================================================
        function filterTable() {
            const filterValue = document.getElementById('filterStatus').value;
            
            if (filterValue === 'all') {
                renderTable(allRegistrants);
            } else {
                const filtered = allRegistrants.filter(item => item.debtStatus === filterValue);
                renderTable(filtered);
            }
        }

        // ==================================================
        // ‚úèÔ∏è Update Payment Status
        // ==================================================
        async function updatePaymentStatus(rowIndex, newStatus) {
            try {
                showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï...');
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'updateStatus',
                        rowIndex: rowIndex,
                        status: newStatus
                    })
                });

                showToast('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                
                // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                setTimeout(() => loadDataFromSheets(), 1000);
                
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            }
        }

        // ==================================================
        // üóëÔ∏è Delete Registrant
        // ==================================================
        async function deleteRegistrant(rowIndex) {
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
            
            try {
                showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...');
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'deleteRow',
                        rowIndex: rowIndex
                    })
                });

                showToast('‚úÖ ‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                
                // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                setTimeout(() => loadDataFromSheets(), 1000);
                
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            }
        }

        // ==================================================
        // üìÅ Export to CSV
        // ==================================================
        function exportToCSV() {
            if (allRegistrants.length === 0) {
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');
                return;
            }

            const headers = ['‡∏•‡∏≥‡∏î‡∏±‡∏ö', '‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', '‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô', '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£', 'Line ID', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏ô‡∏µ‡πâ', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞'];
            const rows = allRegistrants.map((item, index) => [
                index + 1,
                item.fullname,
                item.nickname,
                item.phone,
                item.lineId,
                getDebtStatusText(item.debtStatus),
                item.timestamp,
                item.paymentStatus === 'confirmed' ? '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö'
            ]);

            let csvContent = '\uFEFF'; // BOM for Thai characters
            csvContent += headers.join(',') + '\n';
            csvContent += rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `registrants_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();

            showToast('‚úÖ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        }

        // ==================================================
        // üõ†Ô∏è Helper Functions
        // ==================================================
        function getDebtStatusBadge(status) {
            const badges = {
                normal: '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">üü¢ ‡∏õ‡∏Å‡∏ï‡∏¥</span>',
                warning: '<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full">üü° ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏∂‡∏á</span>',
                heavy: '<span class="bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded-full">üü† ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏Å</span>',
                critical: '<span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full">üî¥ ‡∏ß‡∏¥‡∏Å‡∏§‡∏ï</span>'
            };
            return badges[status] || status;
        }

        function getDebtStatusText(status) {
            const texts = {
                normal: '‡∏õ‡∏Å‡∏ï‡∏¥',
                warning: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏∂‡∏á',
                heavy: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏Å',
                critical: '‡∏ß‡∏¥‡∏Å‡∏§‡∏ï'
            };
            return texts[status] || status;
        }

        function getPaymentStatusBadge(status) {
            if (status === 'confirmed') {
                return '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>';
            }
            return '<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full">‚è≥ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function resetForm() {
            document.getElementById('regisForm').reset();
            document.getElementById('editIndex').value = '-1';
            document.getElementById('cancelEditBtn').classList.add('hidden');
            document.getElementById('submitBtn').innerHTML = '<i class="fa-solid fa-paper-plane mr-2"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô';
            
            // Reset ‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ
            slipImageBase64 = null;
            slipFileName = null;
            document.getElementById('uploadArea').classList.remove('hidden');
            document.getElementById('imagePreview').classList.add('hidden');
            
            hideAlert();
        }

        // ‡πÄ‡∏Å‡πá‡∏ö base64 ‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ
        let slipImageBase64 = null;
        let slipFileName = null;

        function handleFileSelect(input) {
            const file = input.files[0];
            if (file) {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showToast('‚ùå ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB');
                    input.value = '';
                    return;
                }
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå
                if (!file.type.startsWith('image/')) {
                    showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                    input.value = '';
                    return;
                }

                slipFileName = file.name;
                document.getElementById('fileName').textContent = file.name;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    slipImageBase64 = e.target.result;
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('uploadArea').classList.add('hidden');
                    document.getElementById('imagePreview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function removeImage() {
            slipImageBase64 = null;
            slipFileName = null;
            document.getElementById('slipFile').value = '';
            document.getElementById('uploadArea').classList.remove('hidden');
            document.getElementById('imagePreview').classList.add('hidden');
        }

        function showAlert(type, message) {
            const alertBox = document.getElementById('alertBox');
            alertBox.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
            
            if (type === 'success') {
                alertBox.classList.add('bg-green-100', 'text-green-800');
                alertBox.innerHTML = `<i class="fa-solid fa-check-circle mr-2"></i>${message}`;
            } else {
                alertBox.classList.add('bg-red-100', 'text-red-800');
                alertBox.innerHTML = `<i class="fa-solid fa-exclamation-circle mr-2"></i>${message}`;
            }
        }

        function hideAlert() {
            document.getElementById('alertBox').classList.add('hidden');
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // ==================================================
        // üöÄ Initialize
        // ==================================================
        document.addEventListener('DOMContentLoaded', function() {
            // Check if script URL is configured
            if (GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_SCRIPT_WEB_APP_URL_HERE') {
                console.warn('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ GOOGLE_SCRIPT_URL ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
            }
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö session login
            checkSession();
        });

        // ‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å modal
        document.getElementById('loginModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeLoginModal();
            }
        });

        // ‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeLoginModal();
            }
        });
    </script>

</body>
</html>
